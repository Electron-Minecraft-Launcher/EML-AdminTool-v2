#!/bin/bash
# Copyright (c) 2026, GoldFrite
# This script is under the GPL-3.0 license.
#
# This script is used to install EML AdminTool v2.0.0-beta.9.

echo "                                                                        "
echo " ______ __  __ _                    _           _    _______          _ "
echo "|  ____|  \/  | |          /\      | |         (_)  |__   __|        | |"
echo "| |__  | \  / | |         /  \   __| |_ __ ___  _ _ __ | | ___   ___ | |"
echo "|  __| | |\/| | |        / /\ \ / _\` | '_ \` _ \| | '_ \| |/ _ \ / _ \| |"
echo "| |____| |  | | |____   / ____ \ (_| | | | | | | | | | | | (_) | (_) | |"
echo "|______|_|  |_|______| /_/    \_\__,_|_| |_| |_|_|_| |_|_|\___/ \___/|_|"
echo "                                                                        "
echo "                                     _           _        _ _           "
echo "                                    (_)         | |      | | |          "
echo "                                     _ _ __  ___| |_ __ _| | | ___ _ __ "
echo "                                    | | '_ \/ __| __/ _\` | | |/ _ \ '__|"
echo "                                    | | | | \__ \ || (_| | | |  __/ |   "
echo "                                    |_|_| |_|___/\__\__,_|_|_|\___|_|   "
echo "                                                                        "
echo "                                                                        "
echo "EML AdminTool v2.0.0-beta.9 Installer"
echo "Copyright (c) 2026, GoldFrite"
echo "This script is under the GPL-3.0 license."
echo ""

# Check OS
echo ""
echo -e "• \e[1mChecking OS...\e[0m"

os=""
arch=""
platform=""

if [ "$(uname -m)" == "x86_64" ]; then
  arch="x86_64"
elif [ "$(uname -m)" == "aarch64" ] || [ "$(uname -m)" == "arm64" ]; then
  arch="aarch64"
else
  echo -e "\e[31mThis script is not compatible with your OS. Exiting.\e[0m"
  exit 1
fi

if [ "$(uname)" == "Darwin" ]; then
  os="mac"
  platform="darwin"
  echo -e "Running on macOS $arch."
elif [ "$(uname)" == "Linux" ]; then
  os="linux"
  platform="linux"
  echo -e "Running on Linux $arch."
else
  echo -e "\e[31mThis script is not compatible with your OS. Exiting.\e[0m"
  exit 1
fi

# Check Docker and Docker Compose
echo ""
echo -e "• \e[1mChecking Docker...\e[0m"

if ! [ -x "$(command -v docker)" ]; then
  echo -e "\e[31mDocker is not installed. Exiting.\e[0m"
  exit 1
fi
if ! docker compose version >/dev/null 2>&1; then
  echo -e "\e[31mDocker Compose v2 is not installed. Exiting.\e[0m"
  exit 1
fi
echo -e "Docker and Docker Compose are installed."

# Check wget or curl
echo ""
echo -e "• \e[1mChecking wget or curl...\e[0m"

fetcher=""

if [ -x "$(command -v curl)" ]; then
  fetcher="curl"
  echo -e "Using curl."
elif [ -x "$(command -v wget)" ]; then
  fetcher="wget"
  echo -e "Using wget."
else
  echo -e "\e[31mNeither wget nor curl is installed. Exiting.\e[0m"
  exit 1
fi

# Configuration
echo ""
echo -e "• \e[1mNetwork configuration...\e[0m"

LOCAL_IP="127.0.0.1"
if [ "$os" == "mac" ]; then
  LOCAL_IP=$(ipconfig getifaddr en0 2>/dev/null || echo "127.0.0.1")
else
  LOCAL_IP=$(hostname -I 2>/dev/null | tr ' ' '\n' | grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || echo "127.0.0.1")
fi
echo "Local IP detected:    $LOCAL_IP"

PUBLIC_IP=""
echo -n "Public IP detected:   "
if [ "$fetcher" == "wget" ]; then
  PUBLIC_IP=$(wget -4 -qO- --timeout=3 https://ifconfig.me 2>/dev/null)
else
  PUBLIC_IP=$(curl -4 -s --max-time 3 https://ifconfig.me 2>/dev/null)
fi

if [ -n "$PUBLIC_IP" ]; then
  echo "$PUBLIC_IP"
else
  echo "Failed (offline or blocked). Skipping."
fi

echo ""
echo "Do you have a custom domain pointing to this server?"
echo "Example: admintool.myserver.com (Enter WITHOUT http:// or https://)"
read -p "Domain (leave empty if none): " CUSTOM_DOMAIN < /dev/tty

if [ -n "$CUSTOM_DOMAIN" ]; then
  CUSTOM_DOMAIN=$(echo "$CUSTOM_DOMAIN" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
fi

ORIGINS="http://localhost:8080,http://127.0.0.1:8080,http://$LOCAL_IP:8080"

if [ -n "$PUBLIC_IP" ]; then
  ORIGINS="$ORIGINS,http://$PUBLIC_IP:8080,https://$PUBLIC_IP:8080"
fi

if [ -n "$CUSTOM_DOMAIN" ]; then
  ORIGINS="$ORIGINS,http://$CUSTOM_DOMAIN,https://$CUSTOM_DOMAIN"
  PRIMARY_ORIGIN="https://$CUSTOM_DOMAIN"
elif [ -n "$PUBLIC_IP" ]; then
  PRIMARY_ORIGIN="http://$PUBLIC_IP:8080"
else
  PRIMARY_ORIGIN="http://$LOCAL_IP:8080"
fi

echo "# EML AdminTool Environment Configuration" > .env
echo "NODE_ENV=production" >> .env
echo "ORIGIN=$PRIMARY_ORIGIN" >> .env
echo "ALLOWED_ORIGINS=$ORIGINS" >> .env

echo ""
echo -e "Configuration saved to $INSTALL_DIR/.env"
echo -e "Allowed Origins: \e[2m$ORIGINS\e[0m"

# Install EML AdminTool
echo ""
echo -e "• \e[1mInstalling EML AdminTool...\e[0m"

INSTALL_DIR="$HOME/.eml/admintool"
mkdir -p "$INSTALL_DIR"
URL="https://github.com/Electron-Minecraft-Launcher/EML-AdminTool-v2/releases/download/v2.0.0-beta.9/docker-compose.prod.yml"

if [ "$fetcher" == "curl" ]; then
  curl -sSL "$URL" -o "$INSTALL_DIR/docker-compose.prod.yml"
else
  wget -qO "$INSTALL_DIR/docker-compose.prod.yml" "$URL"
fi

cd "$INSTALL_DIR" || exit 1

start_docker() {
  if docker compose -f docker-compose.prod.yml up -d 2>/dev/null; then
    return 0
  fi
  
  echo -e "\e[33mDocker permissions denied. Trying with sudo...\e[0m"
  
  if sudo docker compose -f docker-compose.prod.yml up -d; then
    return 0
  fi
  
  return 1
}

if start_docker; then
  echo ""
  echo -e "\e[32mEML AdminTool is successfully installed and running! \e[0m"
  echo -e "Access it at \e[1mhttp://localhost:8080\e[0m or at \e[1m$PRIMARY_ORIGIN\e[0m if your reverse proxy is set up."
  echo ""
  read "⭐️ Do not forget to star the GitHub repository!"
else
  echo ""
  echo -e "\e[31mFailed to start Docker containers.\e[0m"
  echo "Please ensure Docker is running and you have permissions."
fi